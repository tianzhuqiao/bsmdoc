{!exec|firstRunOnly||{%
import inspect
import six
@BFunction('codesnippet')
def bsmdoc_codesnippet(data, *args, **kwargs):
    d = eval(data)
    if isinstance(d, six.string_types):
        return d
    else:
        return inspect.getsource(d)
%}!}
= What is bsmdoc?
bsmdoc is a tool to generate technical static html docs:
-\tag{b|Light-weighted};
-\tag{b|Highly extendable};
-\tag{b|Single file doc}: generate everything in a single file.

bsmdoc splits the whole doc into blocks (e.g., equation block, paragraph block, heading block, ...). In the following sections, we will show each block in detail, as well as the way to extend the existing blocks.

== Installation
bsmdoc can be installed with pip
{!highlight|shell||{%
$ pip install bsmdoc
%}!}

You can also clone the [https://github.com/tianzhuqiao/bsmdoc|repository] and run setup.py
{!highlight|shell||{%
$ pip install -e .
%}!}

== Get Started
{!exec|firstRunOnly||{%
defines = {}
@BFunction('define')
def bsmdoc_define(data, *args, **kwargs):
    if not args:
        return ""
    defines[args[0]] = data
    return ""

bsmdoc_include_origin = BFunction().include
@BFunction('include')
def bsmdoc_include(data, *args, **kwargs):
    alias = data.strip()
    if alias and alias in defines:
        return defines[alias]
    return bsmdoc_include_origin(data, *args, **kwargs)

@BFunction('example')
def bsmdoc_example(data, *args, **kwargs):
    template = ("{!div|bs-example||\n"
                "%s\n"
                "!}{!div|bs-example-src||highlight|bsmdoc||{%%\n"
                "%s\n"
                "%%}!}\n")
    return template%(data, data)
%}!}
{!exec|firstRunOnly||{%
@BFunction('helloworld')
def bsmdoc_helloworld(data, *args, **kwargs):
    import os
    gen = True
    if args and args[0] == 'bsmdoc':
        with open('helloworld.bsmdoc', 'r') as f:
            return ''.join(f.readlines())
    try:
        doc = os.path.getmtime('helloworld.bsmdoc')
        html = os.path.getmtime('helloworld.html')
        bsmdoc = os.path.getmtime(__file__)
        if doc < html and bsmdoc < html:
            gen = False
    except:
        traceback.print_exc(file=sys.stdout)
        gen = True
    if gen:
        os.system("bsmdoc helloworld.bsmdoc")
    with open('helloworld.html', 'r') as f:
        return ''.join(f.readlines())
    return data
%}!}

* {Create a file (e.g., \tag{strong|helloworld.bsmdoc}) with content
{!highlight|bsmdoc||helloworld|bsmdoc||{%
%}!}
}
* {Compile the file
{!highlight|console||{%
$ bsmdoc helloworld.bsmdoc
%}!}}
* {It will generate \tag{strong|helloworld.html} in the same folder, which may look like
{!highlight|html||helloworld||
!}
}
== 1-minute Tutorial
bsmdoc also provides some commands to create project and .bsmdoc.
* {First, create a project
{!highlight|console||{%
$ mkdir myprj
$ cd myprj
$ bsmdoc init
%}!}
The last command will
** copy the default css and javascript files to the current folder;
** create \tag{b|index.bsmdoc} from template;
** generate \tag{b|index.html} from \tag{b|index.bsmdoc}.
}
* {Now, you can update the \tag{b|index.bsmdoc} and then regenerate the html
{!highlight|console||{%
$ bsmdoc index.bsmdoc
%}!}
}
* {Add a new doc from template to current folder
{!highlight|console||{%
$ bsmdoc new page
%}!}
It will create the \tag{b|page.bsmdoc} from template.
}

= Heading \label{sec-heading}
\config{heading_in_contents|False}
\config{heading_numbering|False}
\tag{b|heading} block is defined by a line starting with \tag{code|=}
{!define|example_heading||example||{%
= level 1
== level 2
=== level 3
==== level 4
===== level 5
====== level 6
%}!}
#include example_heading

As you have seen, heading block must start at a new line. Otherwise, \tag{code|=} (e.g., in a paragraph) is just normal equal sign.
bsmdoc supports all 6 heading levels as shown above. However, we don't think anyone needs all these 6 levels (remember, [http://www.feynmanlectures.caltech.edu/|"The Feynman Lectures on Physics"] only uses 2 levels).

heading text can spread over multiple lines as long as they are enclosed by "\tag{code|\{\}}", as shown in the following example. Actually, "\tag{code|\{\}}" also define a basic block in bsmdoc. It is quite flexible to define the heading text; generally, you are allowed to put everything in it.
{!define|example_heading_multiline||example||{%
= {multiple\n
line\n
heading}
= {multiple
line
heading}
%}!}
#include example_heading_multiline

To add reference to the \tag{b|heading} block, first you need to add a label with command "\tag{code|{%\label%}}". Then, it can be referenced as a normal in-page [#sec-link|link].

{!define|example_heading_ref||example||{%
= {section with label \label{sec-label}}
This [#sec-label|section] ...
%}!}
#include example_heading_ref

By default, the heading block will not be automatically numbered. The following configuration is used to turn on the automatic numbering
{!highlight|bsmdoc||{%
\config{heading_numbering|True}
%}!}

bsmdoc will not start the automatic heading numbering until you set the above flag. Thus if you want bsmdoc to add numbering to the whole doc, simply put the above configuration line at the beginning of the doc. You also can set the start heading level for automatic numbering. For example, the following line will tell bsmdoc to start heading numbering from level 2 (i.e., \tag{code|H2})
{!highlight|bsmdoc||{%
\config{heading_numbering_start|2}
%}!}

When referencing to a \tag{b|heading} block with automatic heading numbering on, the link text will be automatically filled with its index if it is empty,
{!define|example_heading_ref2||example||{%
Sec. [#sec-heading] ...
%}!}
#include example_heading_ref2
It can also be achieved by \tag{code|{%\ref%}} command
{!define|example_heading_ref3||example||{%
Sec. \ref{sec-heading}...
%}!}
#include example_heading_ref3
\config{heading_in_contents|True}
\config{heading_numbering|True}

bsmdoc will generate the table of contents from the
headings, if the following configuration is enabled
{!highlight|bsmdoc||{%
\config{show_table_of_contents|True}
%}!}

Only the headings with automatic numbering will be included in the content list.
The table of contents is generated by a function block \tag{b|makecontent}.
 Its input is a list that contains all the headings. The default implementation generates an un-ordered list
{!highlight|python||codesnippet||
BFunction().makecontent.func_closure
!}
= List
bsmdoc defines two kinds of list blocks: \tag{b|unordered list} and \tag{b|ordered list}.
A line leading with "\tag{code|-}" will be rendered as unordered list. "\tag{code|-}" will be ignored if it is not at the start of a line. Such rule holds for all \tag{b|heading}, \tag{b|unordered list}, and \tag{b|ordered list} blocks.

{!define|example_list||example||{%
- start each line
- with an hyphen -.
-- more asterisks gives deeper
--- and deeper levels.
- line breaks\n don't break levels.
--- but jumping levels creates empty space.
any other start ends the list.
%}!}
#include example_list
Ordered list starts with "\tag{code|*}"
{!define|example_list_ordered||example||{%
* start each line
* with a start '*'
** more asterisks gives deeper
*** and deeper levels.
* line breaks\n don't break levels.
*** but jumping levels creates empty space.
any other start ends the list.
%}!}
#include example_list_ordered
\tag{b|unordered} and \tag{b|ordered} lists can also be arbitrarily combined
{!define|example_list_combine||example||{%
- unordered level 1
-* ordered item 1
-* ordered item 2
-- unordered item 3
-- unordered item 4
%}!}
#include example_list_combine

Each item of a list can spread over multiple lines as long as they are enclosed by "\tag{code|\{\}}":

{!define|example_list_long||example||{%
- {unordered level 1\n
 more text here
[bsmdoc.feiyilin.com | bsmdoc]
}
-* ordered item2
%}!}
#include example_list_long

= Link \label{sec-link}
Text between \tag{code|\[} and \tag{code|\]} will be rendered as link block

{!define|example_link||example||{%
[http://bsmedit.feiyilin.com]
%}!}
#include example_link

Link text can be customized with "\tag{code|\|}"
{!define|example_link_text||example||{%
[http://bsmdoc.feiyilin.com | bsmdoc]
%}!}
#include example_link_text

Or email
{!define|example_link_email||example||{%
[mailto:tq@feiyilin.com | Email]
%}!}
#include example_link_email

You can also easily define in-page links with \tag{code|{%\anchor%}} command
{!define|example_link_anchor||example||{%
In page link \anchor{myanchor}
%}!}
#include example_link_anchor

Then, you can link to the in-page link by
{!define|example_link_anchor_ref||example||{%
My in-page [#myanchor|link]
%}!}
#include example_link_anchor_ref

== Footnote
One special in-page link is \tag{code|footnote}\anchor{footnote}. It will automatically add the link to the position it gets defined, and add the footnote content at the end of the page. bsmdoc also adds a shortcut at the end of the footnote content, so you can return to the footnote definition position easily.
{!define|example_footnote||example||{%
footnote example\footnote{This is a footnote}.
%}!}
#include example_footnote

bsmdoc will automatically add indexing to each footnote. When you move the cursor to the footnote link, the footnote content will be shown in a popup window. So you may not need to go to the end of the page to see the footnote content. The [#sec-image|image], [#sec-equation|equation] and [#sec-table|table] blocks support similar feature.

==Reference & Citation
bsmdoc has an easy way to add references and citations. For example, the following command will add a book reference
\reference{Simon|Simon Haykin, "Adaptive Filter Theory," Prentice Hall, 4th edition, Sep. 2001}
{!highlight|bsmdoc||{%
\reference{Simon|Simon Haykin, "Adaptive Filter Theory," Prentice Hall, 4th edition, Sep. 2001}
%}!}
\tag{strong|Simon} before "\tag{code|\|}" is the alias, which can be used to cite it, e.g.,
{!define|example_citation||example||{%
The LMS algorithm in \cite{Simon}...
%}!}
#include example_citation
And the reference is not required to be defined before citation. If bsmdoc can not find the reference when it sees \tag{code|\\cite}, it will trigger the second scan, in case the reference is defined after the citation. If the reference is still missing at the second scan, bsmdoc will show a warning.

All cited references will be appended to the end of the document in the citation order. If you want to add the reference without citation, you can use the \tag{code|hide} argument of the \tag{code|cite} command
{!highlight|bsmdoc||{%
\cite{hide|Simon}...
%}!}
In this case, it will not generate the link to the reference, but the reference will still be added to the reference list even if there is no explicit citation in the document.

= Image & Video \label{sec-image}
== Image \label{sec-image-image}
{!exec|firstRunOnly||{%
import os.path
if not os.path.isfile("image/scatter.svg"):
    import matplotlib.pyplot as plt
    import numpy as np

    plt.clf()
    plt.figure(figsize=(4,4))
    N = 50
    x = np.random.rand(N)
    y = np.random.rand(N)
    colors = np.random.rand(N)
    area = np.pi * (15 * np.random.rand(N))**2  # 0 to 15 point radii

    plt.scatter(x, y, s=area, c=colors, alpha=0.5)
    plt.savefig("image/scatter.svg")
%}!}

The syntax of the \tag{b|image} block is

{!highlight|bsmdoc||{%
{!image||
image_file_path
!}
%}!}

So, to include an image
{!define|example_image||example||{%
{!image||
./image/scatter.svg
!}
%}!}
#include example_image

You can add optional caption to an image block
{!define|example_image_caption||example||{%
{!image||
\caption{Example scatter image}
./image/scatter.svg
!}
%}!}
#include example_image_caption

To add reference to an image, you need to
* { add a label to an image block with \tag{code|\\label} command
{!define|example_image_label||example||{%
{!image||
\label{img-scatter}
\caption{Example scatter image}
./image/scatter.svg
!}
%}!}
#include example_image_label
}
* { add reference to the image with \tag{code|\\ref} command
{!define|example_image_ref||example||{%
Fig. \ref{img-scatter} shows a scatter diagram
%}!}
#include example_image_ref
}

Here the reference link \tag{code|{%\ref{img-scatter}%}}) is defined after the definition of the image block. The reference link text is automatically replaced with the image index. In some case, if the reference link is created before the image block is defined, bsmdoc will not know the destination when it sees the reference link. In this case, the second scan will automatically be triggered to solve the reference link.

When the cursor is moved to the reference link, the referenced image will be highlighted if it is visible; otherwise, the image will be shown in a popup window. Such feature is inspired by [http://www.feynmanlectures.caltech.edu/|"The Feynman Lectures on Physics"] website. It allows you to view the images at the current reference position. Otherwise, you would have to follow the link to the original place where the image is first included. To use such feature, the image label should start with "\tag{code|img-}", which is hard-coded in the Javascript. The references to [#sec-equation|equation], [#sec-table|table], and [#footnote|footnote] behave similarly.

As you have seen, the image block can automatically add the numbering to the image with label. The default automatic indexing format is: "\tag{code|Fig. I.}", where "\tag{code|I}" is the current index. You can configure the automatic prefix text. For example, to change it to "\tag{code|Image }", the following line can be inserted before a image block definition (usually at the beginning of the doc, so that it affects all the image blocks)

{!highlight|bsmdoc||{%
\config{image_numbering_prefix|Image }
%}!}
For example
{!define|example_image_prefix||example||{%
{!image||
\config{image_numbering_prefix|Image }
\label{img-scatter2}
\caption{Example scatter image}
./image/scatter.svg
!}
%}!}
#include example_image_prefix

The options to configure the image numbering
{{
Option | Description ||+
image_numbering | \tag{b|True} or \tag{b|False} (default). Turn on/off numbering, e.g., \highlight{bsmdoc|{%\config{image_numbering|True}%}}||-
image_numbering_prefix | The numbering prefix (default "\tag{b|Fig.}"). To change the prefix, e.g., \highlight{bsmdoc|{%\config{image_numbering_prefix|Image.}%}}||-
image_numbering_num_prefix | The numbering prefix (default ""). To change the prefix, e.g., \highlight{bsmdoc|{%\config{image_numbering_num_prefix|3.}%}}||-
}}

== Video
Video block is almost same as the image block. Its syntax is
{!highlight|bsmdoc||{%
{!video||
video_file_path
!}
%}!}

For example, to add reference to an image, you need to
* { add a label to an image block with \tag{code|\\label} command
{!define|example_video_label||example||{%
{!video||
\label{video-waves}
\caption{Example video}
./image/waves.mp4
!}
%}!}
#include example_video_label
}
* { add reference to the image with \tag{code|\\ref} command
{!define|example_video_ref||example||{%
Vid. \ref{video-waves} shows a scatter diagram
%}!}
#include example_video_ref
}

The options to configure the video numbering
{{
Option | Description ||+
video_numbering | \tag{b|image} (default) or \tag{b|True} or \tag{b|False}. Turn on/off numbering. If it is set to \tag{b|image}, then it will share numbering with [#sec-image-image|image] block. ||-
video_numbering_prefix | The numbering prefix (default "\tag{b|Video.}"). Only valid if \tag{b|video_numbering} is not \tag{b|image}.||-
video_numbering_num_prefix | The numbering prefix (default ""). Only valid if \tag{b|video_numbering} is not \tag{b|image}.||-
}}

= Equation \label{sec-equation}
Equation is rendered with [http://www.mathjax.org|mathjax]: both inline and normal equation blocks. The [http://docs.mathjax.org/en/latest/web/configuration.html|configuration] may look like:
{!highlight|html||{%
<script>
    MathJax = {
        tex: {
            inlineMath: [['\\(', '\\)']],
            tags: "all"
        }
};
</script>

<script id="MathJax-script" async
src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-mml-chtml.js">
</script>
%}!}

Such configuration can be included in a configuration file, which will be shown in detail in Sec. [#sec-template].

bsmdoc looks for "\tag{code|\\\(...\\\)}" (or "\tag{code|\$...\$}") as delimiters for inline equation block

{!define|example_equation||example||{%
Newton's second law is often stated as \(F=ma\), which means the force (\(F\)) acting on an object is equal to the mass ($m$) of an object times its acceleration ($a$).
%}!}
#include example_equation

The normal equation block looks like
{!highlight|bsmdoc||{%
{!math||{%
Latex Equation
%}!}
%}!}
or
{!highlight|bsmdoc||{%
$$
Latex Equation
$$
%}!}
For example
{!define|example_equation_block||example||{%
{!math||{%
\begin{align}
\begin{bmatrix}
0      & \cdots & 0      \\
\vdots & \ddots & \vdots \\
0      & \cdots & 0
\label{eqn:matrix}
\end{bmatrix}
\end{align}
%}!}
%}!}
#include example_equation_block

bsmdoc generally keeps the equation content (i.e., the content between \tag{code|\{\%...\%\}}) untouched, except \tag{code|<} and \tag{code|>}, which will be replaced with \tag{code|&amp;lt;} and \tag{code|&amp;gt;} respectively, to avoid conflicts with html tags. For example,
{!div|bs-example||pre||{%
$a &amp;gt; 5$
%}!}{!div|bs-example-src||highlight|bsmdoc||{%
$a>5$
%}!}

Unlike the [#sec-image|image] block mentioned above, the reference to equation is also handled by [http://www.mathjax.org|mathjax]. The syntax is same as $Latex$

{!define|example_equation_ref||example||{%
Eq. (\ref{eqn:matrix}) or
Eq. (\eqref{eqn:matrix})
%}!}
#include example_equation_ref

As mentioned above, same as the [#sec-image|image] block, when move the cursor to the equation reference link, bsmdoc will highlight the referenced equation if it is visible. Otherwise, a popup window will be displayed to show the equation.

= Table \label{sec-table}
The table block is defined with \tag{code|\{\{...\}\}}, where
- each row is ended by "\tag{code|\|-}";
- each column in a row is terminated by "\tag{code|\|}".

The content in each column of each row can be anything defined above, for example, [#sec-link|Link], [#sec-image|Image], [#sec-equation|Equation],...
{!define|example_table||example||{%
{{
item1 | $E=MC^2$ ||-
[http://bsmdoc.feiyilin.com|bsmdoc] | {!div|figure|image-left|image-thumbnail||\image{image/scatter.svg}!} ||-
}}
%}!}
#include example_table

Optionally, a heading line can be added in the front of the table block
- {the heading line is delimited by "\tag{code|\|\+}".
{!define|example_table_heading||example||{%
{{
Heading1 | Heading2||+
item1 | item2 ||-
item3 | item4 ||-
}}
%}!}
#include example_table_heading
}
Furthermore, a caption can be added to the table block too
\config{table_numbering|False}
{!define|example_table_caption||example||{%
{{
\caption{Example table title}
Heading1 | Heading2||+
item1 | item2 ||-
item3 | item4 ||-
}}
%}!}
#include example_table_caption

bsmdoc can also add the automatic indexing to the table caption. To do that, you need to
* {turn on the option
{!highlight|bsmdoc||{%
\config{table_numbering|True}
%}!}
bsmdoc will add the automatic indexing to all the tables defined after the above line, until you explicitly turn off the configuration.
}
* {add the label to each table if you want to reference it
{!highlight|bsmdoc||{%
\label{table_label}
%}!}}
For example
\config{table_numbering_prefix|Table.}
{!define|example_table_numbering||example||{%
{{
\config{table_numbering|True}
\label{tbl-example}
\caption{Example table title}
Heading1 | Heading2||+
item1 | item2 ||-
item3 | item4 ||-
}}
%}!}
#include example_table_numbering

The default automatic indexing format is: "\tag{code|Table. I.}", where "\tag{code|I}" is the current index. It can also be customized. For example, to change it to "\tag{code|TABLE }", the following line can be inserted before the table block definition
{!highlight|bsmdoc||{%
\config{table_numbering_prefix|TABLE }
%}!}

{!define|example_table_prefix||example||{%
{{
\config{table_numbering_prefix|TABLE }
\label{tbl-example2}
\caption{Example table title}
Heading1 | Heading2||+
item1 | item2 ||-
item3 | item4 ||-
}}
%}!}
#include example_table_prefix

#You can also add the prefix indexing to the automatic indexing
#{!highlight|bsmdoc||{%
#\config{table_numbering_num_prefix|7.}
#%}!}
#{!div|bs-example||
#{{
#\config{table_numbering_num_prefix|7.}
#\config{label|tbl-example3}
#\config{caption|Example table title}
#Heading1 | Heading2||+
#item1 | item2 ||-
#item3 | item4 ||-
#}}
#!}{!div|bs-example-src ||highlight|bsmdoc||{%
#{{
#\config{image_numbering_num_prefix|7.}
#\config{label|tbl-example3}
#\config{caption|Example table title}
#Heading1 | Heading2||+
#item1 | item2 ||-
#item3 | item4 ||-
#}}
#%}!}

The label enables not only the automatic indexing, but also the cross-reference. Reference to a table is as easy as [#sec-image|image] and [#sec-equation|equation] blocks
{!define|example_table_ref||example||{%
Table \ref{tbl-example} shows how to make a table in bsmdoc.
%}!}
#include example_table_ref

If the table label text starts with "\tag{code|tbl-}", when the cursor is moved to the reference index, the table will be highlighted if it is visible; otherwise, a popup window will be displayed to show the table content.

The options to configure the table numbering
{{
Option | Description ||+
table_numbering | \tag{b|True} or \tag{b|False} (default). Turn on/off numbering.||-
table_numbering_prefix | The numbering prefix (default "\tag{b|Table.}").||-
table_numbering_num_prefix | The numbering prefix (default "").||-
}}

= Syntax Highlighting \label{sec-highlight}
bsmdoc uses [http://pygments.org/docs/quickstart/ | Pygments] for syntax highlighting. The syntax is
{!highlight|bsmdoc||{%
{!highlight|language||{%
code
%}!}
%}!}
where \tag{code|language} can be any language supported by [http://pygments.org/languages/|Pygments]. For example,
- {Python
{!define|example_highlight||example||{%
{!highlight|python||{%
print("Hello World")
%}!}
%}!}
#include example_highlight
}
- {Matlab
{!define|example_highlight_matlab||example||{%
{!highlight|matlab||{%
fprintf(1, 'Hello, world!\n');
%}!}
%}!}
#include example_highlight_matlab
}
-{C++
{!define|example_highlight_cpp||example||{%
{!highlight|C++||{%
#include <iostream>
using namespace std;

int main ()
{
    cout << "Hello World!";
    return 0;
}
%}!}
%}!}
#include example_highlight_cpp
}

The \tag{code|highlight} block supports a couple of options to format the code:
- \tag{b|obeytabs}: to replace \tag{b|tab} with 4 space
- {\tag{b|gobble=N}: remove the first N characters from each line.
{!define|example_highlight_gobble||example||{%
{!highlight|python|gobble=4||{%
    print("Hello World")
%}!}
%}!}
#include example_highlight_gobble
}
- \tag{b|autogobble}: remove leading common white space from each line.
- {All other keyword arguments will be forwarded to [https://pygments.org/docs/formatters/|HtmlFormatter]. The following example turns on the line number, and highlights line 6.
{!define|example_highlight_cpp_lineno||example||{%
{!highlight|C++|linenos=table|hl_lines=(6,)||{%
#include <iostream>
using namespace std;

int main ()
{
    cout << "Hello World!";
    return 0;
}
%}!}
%}!}
#include example_highlight_cpp_lineno
}

It is also possible to use other packages for syntax highlighting, which will be discussed in detail in Sec. [#sec-funblock].

= Raw Text Block
Sometimes you may want to skip the parsing from bsmdoc. For example, to highlight the code, it is basically not a good idea to let bsmdoc parse the code. Instead, the raw data should be sent to the code highlighting block. In another example, you may have seen similar syntax between the latex macro and the bsmdoc commands (e.g., both are preceded by "\tag{code|\\}"). If bsmdoc tries to parse these latex macros, the result is obviously not what you want. Thus, bsmdoc defines the raw text block. It basically tells bsmdoc to ignore all the rules on its content.
The syntax of the raw text block is

{!highlight|bsmdoc||{%
{%
Content
%}
%}!}

In this case, bsmdoc will stop parsing the \tag{code|Content} between \tag{code|\{\%...\%\}}, and the raw text will be either sent to the final html file or send to the other function blocks to process.

However, sometimes you may still want to slightly process the \tag{code|Content} before sending to the html file. For example, the \tag{code|Content} may contain symbols (e.g., \tag{code|< >}), which may cause conflict to the html tags. You can use the \tag{b|escape} function block to process the data
{!highlight|bsmdoc||{%
{!escape||{%
Content
%}!}
%}!}

In this case, \tag{code|<} and \tag{code|>} will be replaced with \tag{code|&amp;lt;} and \tag{code|&amp;gt;}, respectively.
{!div|info||
The [#sec-equation|equation] block will automatically replace \tag{code|<} (\tag{code|>}) with \tag{code|&amp;lt;} (\tag{code|&amp;gt;}). Thus, there is no need to explicitly call the \tag{b|escape} function block.
!}
By symmetry, bsmdoc also defines the \tag{b|unescape} function block, which will replace \tag{code|&amp;lt;} (\tag{code|&amp;gt;}) with \tag{code|<} (\tag{code|>}).

= Function Block \label{sec-funblock}
Function block makes things really interesting. Without function block, bsmdoc is almost useless. Function block provides a easy way to allow the content to be processed before sent to the final html file.
As you have seen above, the syntax of a function block looks like

{!highlight|bsmdoc||{%
{!command
content
!}
%}!}
where \tag{code|command} is optional and may contain the name and arguments of the corresponding function block.

As described above, many features mentioned above are implemented with function blocks.
For example,
- {[#sec-image|image] block:

{!highlight|bsmdoc||{%
{!image||
image-path
!}
%}!}
}
- {[#sec-equation|equation] block:

{!highlight|bsmdoc||{%
{!math||{%
latex-equation
%}!}
%}!}
}
- {[#sec-highlight|syntax highlight] block:
{!highlight|bsmdoc||{%
{!highlight|language||{%
code
%}!}
%}!}
}
- {div tag
{!div|bs-example||highlight|html||{%
<div class="div-class">
content
</div>
%}!}
{!div|bs-example-src||highlight|bsmdoc||{%
{!div|div-class||
content
!}
%}!}
}
- {pre tag
{!div|bs-example||highlight|html||{%
<pre>
content
</pre>
%}!}
{!div|bs-example-src||highlight|bsmdoc||{%
{!pre||{%
content
%}!}
%}!}
}
- {general tag
{!div|bs-example||highlight|html||{%
<key class="tag-class">
content
</key>
%}!}
{!div|bs-example-src||highlight|bsmdoc||{%
{!tag|key|tag-class||
content
!}
%}!}
}

The \tag{code|command} section is optional. When the \tag{code|command} section is not defined, the function block behaves exactly same as the simple block (\tag{code|\{\}}). Otherwise, the corresponding function will be called to process the content.
As you may have already figured out, the \tag{code|command} section is defined as

{!highlight|bsmdoc||{%
command|arg0|arg1|arg2|...|argN||
%}!}

The command can have arbitrary number of arguments, which are separated by "\tag{code|\|}". And the command is always terminated by "\tag{code|\|\|}". It is also possible to combine multiple commands, e.g.,

{!highlight|bsmdoc||{%
command0|arg0|arg1|arg2||command1|arg0|arg1|arg2||
%}!}

In this case, the commands are called from right to left. Thus in the above example, \tag{code|command1} will be called first, and its result will be sent to \tag{code|command0}. The result from \tag{code|command0} will be sent to the html file. It is equivalently to the following nested blocks
{!highlight|bsmdoc||{%
{!command0|arg0|arg1|arg2||
{!command1|arg0|arg1|arg2||
    content
!}!}
%}!}

The function block makes it easy to extend bsmdoc. We could have defined all kinds of function blocks to generate all html tags, and write a comprehensive doc so we can look up later. We don't. Otherwise, that will not be significantly different from remembering all html syntax. Instead, we make it easy to add new functions.

When bsmdoc sees the following function block
{!highlight|bsmdoc||{%
{!command|arg0|arg1||
    content
!}
%}!}

it will search for the function decorated with "\tag{code|@BFunction('command')}". If found, it will execute the command with list "\tag{code|\[arg0, arg1\]}" as argument. For example, if you want to define a function block to achieve the "\tag{del|delete}" effect,
- {first you need to define the function (e.g., "\tag{code|bsmdoc_del}") with decorator "\tag{code|@BFunction('del')}"; the function name (\tag{code|bsmdoc_del}) is not important.
{!highlight|python||{%
@BFunction('del')
def bsmdoc_del(data, *args, **kwargs):
    return "<del>%s</del>"%data
%}!}{!exec|firstRunOnly||{%
@BFunction('del')
def bsmdoc_del(data, *args, **kwargs):
    return "<del>%s</del>"%data
%}!}
\tag{code|*args} will have all the arguments from the function block. For example, if \tag{code|del} is called as
{!highlight|bsmdoc||{%
{!del|arg0|arg1||
    content
!}
%}!}
then bsmdoc will call \tag{code|bsmdoc_del} by
{!highlight|python||{%
bsmdoc_del("content", "arg0", "arg1", **kwargs)
%}!}

Here \tag{code|**kwargs} are additional arguments from bsmdoc, for example
{{
    argument|description||+
    inline| \tag{code|True} if it is a inline block (we will discuss the inline block shortly).||-
    filename| the current filename||-
    lineno| the line number of the start of the function block||-
    fun_args| the list string arguments from function block||-
    fun_kwargs| the dict of keyword arguments from function block||-
}}
Such info may be helpful to show debugging tips once some error happens.

bsmdoc will also parse the arguments from the function. All string arguments will be in list \tag{b|fun_args} (e.g., \tag{b|'args0'}) and keyword arguments will be in dict \tag{b|fun_kwargs} (e.g., argument \tag{b|key=value} will be convert to \tag{b|fun_kwargs\[key\]=value}). In this case, if \tag{b|value} is a number, it will be convert to a number, e.g., \tag{b|"answer=42"} will be \tag{b|fun_kwargs\['answer'\]=42}; otherwise, \tag{b|value} will be a string, e.g., \tag{b|"today=sunday"} will be \tag{b|fun_kwargs\['today'\]='sunday'}.

For a argument to be recognized as keyword argument, first, it has to have an "\tag{code|\=}" in it; second, the string to the left of the first "\tag{code|\=}" shall be a valid python identifier.
}
- {Now \tag{code|del} (the name from \tag{code|@BFunction} decorator) can be used as all the other blocks,

{!div|bs-example||highlight|html||del||
delete
!}{!div|bs-example-src||highlight|bsmdoc||{%
{!del||
delete
!}
%}!}
}

All \tag{code|command} functions shall return a \tag{strong|string}, which will be sent to the next block or the html file. If the function does not need to change the html file, it shall return the empty string.

The next question is where to put the function definition? One straightforward solution is to define the above \tag{code|bsmdoc_del} function in \tag{b|bsmdoc.py} and then all the documents can use the \tag{code|del} function block. However, that also means once you need some missing features, you need to go back to the \tag{b|bsmdoc.py} and define the functions there. It may cause two potential issues:
- {It needs to edit additional file \tag{b|bsmdoc.py} besides the docs you are working on. Thus the change is not local to the doc itself. If there is some mistake in the code, suddenly no doc can be compiled;}
- How about two docs need slightly different implementation of some function? You may end up either using some slightly different (but not straightforward) function names, or adding additional arguments to the function blocks.
Neither way is scalable. bsmdoc provides the third choice: the function block can be defined in the same doc where it is called. To achieve that, bsmdoc define a special \tag{code|exec} block
{!highlight|bsmdoc||{%
{!exec||{%
code
%}!}
%}!}
which will execute the \tag{code|code} automatically.
Thus, including the following code in your doc will automatically add the \tag{code|bsmdoc_del} function just as it is defined in \tag{b|bsmdoc.py} (but be careful, since bsmdoc will call python function "\tag{code|exec()}" for this feature, it may cause some security concerns).
{!highlight|bsmdoc||{%
{!exec||{%
@BFunction('del')
def bsmdoc_del(data, *args, **kwargs):
    return "<del>%s</del>"%content
%}!}
%}!}

With the \tag{code|exec} block, you can replace all the predefined blocks with this method. For example, you can define your code highlight function block so that you can highlight your own language or with other library
{!highlight|bsmdoc||{%
{!exec||{%
@BFunction('highlight')
def bsmdoc_highlight(data, *args, **kwargs):
    ...
%}!}
%}!}

Or in some case, you just want to use your own function for some arguments. For example, you want to call your own function to highlight the code for a specific language, and use the default function for all the others. In this case, you may try
{!highlight|bsmdoc||{%
{!exec||{%
bsmdoc_highlight_raw = BFunction().highlight # get the current highlight function
@BFunction('highlight')
def bsmdoc_highlight(data, *args, **kwargs):
    if args[0] != 'mylang':
        return bsmdoc_highlight_raw(data, *args, **kwargs)
    # highlight 'mylang'
    ...
%}!}
%}!}

It may work fine to compile most of your docs, until one day it fails and python complains indefinite loop. The problem here is that the above definition assumes such code will only be called once. But it is not always true for bsmdoc. As mentioned before, bsmdoc may scan the doc multiple times to solve the late-defined references. Thus, when bsmdoc executes the above code second time, \tag{code|bsmdoc_highlight_raw} will not refer to the original \tag{code|bsmdoc_highlight}, instead, it will also point to the local defined copy. The definition will be equivalent to
{!highlight|bsmdoc||{%
{!exec||{%
bsmdoc_highlight_raw = BFunction().highlight
@BFunction('highlight')
def bsmdoc_highlight(data, *args, **kwargs):
    if args[0] != 'mylang':
        return bsmdoc_highlight(data, *args, **kwargs)
    # highlight 'mylang'
    ...
%}!}
%}!}

It is apparently an indefinite loop.

Several techniques can be used to solve this problem. For example, you can always define the whole function by yourself, instead of calling the default function in some branches. Or you may check whether the local function has been defined or not
{!highlight|bsmdoc||{%
{!exec||{%
try:
    bsmdoc_highlight_raw
except NameError:
    bsmdoc_highlight_raw = BFunction().highlight
    @BFunction('highlight')
    def bsmdoc_highlight(data, *args, **kwargs):
        if args[0] != 'mylang':
            return bsmdoc_highlight(data, *args, **kwargs)
        # highlight 'mylang'
        ...
%}!}
%}!}

Or you can tell bsmdoc to execute the code for the first scan only
{!highlight|bsmdoc||{%
{!exec|firstRunOnly||{%
bsmdoc_highlight_raw = BFunction().highlight
@BFunction('highlight')
def bsmdoc_highlight(data, *args, **kwargs):
    if lang != 'mylang':
        return bsmdoc_highlight(data, *args, **kwargs)
    # highlight 'mylang'
    ...
%}!}
%}!}

== Generate Images
Besides defining the function block, the \tag{code|exec} block can also be used to execute arbitrary python code (\tag{b|be careful\!}). One application is to embed the python code to generate the figure with [http://matplotlib.org/|matplotlib] package,

{!exec|firstRunOnly||{%
import os.path
if not os.path.isfile("image/pie.svg"):
    import matplotlib.pyplot as plt
    import numpy as np

    plt.clf()
    plt.figure(figsize=(4,4))
    # Compute pie slices
    N = 20
    theta = np.linspace(0.0, 2 * np.pi, N, endpoint=False)
    radii = 10 * np.random.rand(N)
    width = np.pi / 4 * np.random.rand(N)

    ax = plt.subplot(111, projection='polar')
    bars = ax.bar(theta, radii, width=width, bottom=0.0)

    # Use custom colors and opacity
    for r, bar in zip(radii, bars):
        bar.set_facecolor(plt.cm.viridis(r / 10.))
        bar.set_alpha(0.5)
    plt.savefig("image/pie.svg")
%}!}
{!highlight|bsmdoc||{%
{!exec||{%
import os.path
if not os.path.isfile("pie.svg"):
    import matplotlib.pyplot as plt
    import numpy as np

    plt.clf()
    plt.figure(figsize=(4,4))
    # Compute pie slices
    N = 20
    theta = np.linspace(0.0, 2 * np.pi, N, endpoint=False)
    radii = 10 * np.random.rand(N)
    width = np.pi / 4 * np.random.rand(N)

    ax = plt.subplot(111, projection='polar')
    bars = ax.bar(theta, radii, width=width, bottom=0.0)

    # Use custom colors and opacity
    for r, bar in zip(radii, bars):
        bar.set_facecolor(plt.cm.viridis(r / 10.))
        bar.set_alpha(0.5)
    plt.savefig("image/pie.svg")
%}!}
%}!}

Then you can include the \tag{b|pie.svg} in your html file
{!define|example_block_image||example||{%
{!image||
./image/pie.svg
!}
%}!}
#include example_block_image
Thus, there may be no need to use other software to generate figures.

== Include Source Code
With function block, it is easy to include source code in html doc. For example, to import the python source code in your doc, you can define the following function block
{!highlight|bsmdoc||{%
{!exec|firstRunOnly||{%
import inspect
import six
@BFunction('codesnippet')
def bsmdoc_codesnippet(data, *args, **kwargs):
    d = eval(data)
    if isinstance(d, six.string_types):
        return d
    else:
        return inspect.getsource(d)
%}!}
%}!}

Then you can include the source code (e.g., matplotlib.pyplot.plot) by
{!div|bs-example||
{!exec|firstRunOnly||{%
import matplotlib.pyplot as plt
%}!}
{!highlight|python||codesnippet||
plt.plot
!}
!}
{!div|bs-example-src||highlight|bsmdoc||{%
{!exec|firstRunOnly||{%
import matplotlib.pyplot as plt
%}!}
{!highlight|python||codesnippet||
plt.plot
!}
%}!}

It can be easily extended to include arbitrary code. For example, the following block returns the content of a source file. Of course, you can write a function block to just return certain sections (e.g., a function), instead of the whole file.
{!highlight|bsmdoc||{%
{!exec|firstRunOnly||{%
@BFunction('ccodesnippet')
def bsmdoc_ccodesnippet(data, *args, **kwargs):
    with open(data.strip(), 'r') as f:
        return ''.join(f.readlines())
    return data
%}!}
%}!}
{!exec|firstRunOnly||{%
@BFunction('ccodesnippet')
def bsmdoc_ccodesnippet(data, *args, **kwargs):
    with open(data.strip(), 'r') as f:
        return ''.join(f.readlines())
    return data
%}!}
Then you can include the source code by
{!div|bs-example||
{!highlight|javascript||ccodesnippet||
js/menu.js
!}
!}
{!div|bs-example-src||highlight|bsmdoc||{%
{!highlight|javascript||ccodesnippet||
js/menu.js
!}
%}!}

== Inline Function Block
The difference between \tag{b|function block} and \tag{b|inline function block} is similar to the \tag{b|equation block} and \tag{b|inline equation block}. In other words, the output of the inline block can be embedded in paragraphs. The syntax is similar to the $\LaTeX$ macro:
{!highlight|bsmdoc||{%
\command{arg0|arg1|...|argN|content}
%}!}

In general, the blocks defined in the above section can also be used as inline block. For example

{!div|bs-example||highlight|html||
\tag{code|content}
\pre{content}
!}{!div|bs-example-src||highlight|bsmdoc||
{%
\tag{code|content}
\pre{content}
%}
!}

bsmdoc defines a special inline function block for configuration (\tag{code|{%\config{}%}}). It adds a configuration item to bsmdoc's global configuration table, and output empty string to the html file. Thus, it will not directly update the html docs, although the other blocks may rely on such configurations to control their behaviors. The syntax is

{!highlight|bsmdoc||{%
\config{option|value}}
%}!}

We have seen [#sec-heading|heading], [#sec-image|image], and [#sec-table|table] blocks use such feature to set the label and caption. We will see more configurations in Sec. [#sec-template].

== Express Function Block
Besides the way mentioned above, there is a shortcut to define a function block, if it returns a simple string. The syntax to define a function is
{!div|bs-demo||highlight|bsmdoc||{%
\newfun{name|content}
%}!}
For example
{!highlight|bsmdoc||{%
\newfun{bsmdoc|\tag{strong|bsmdoc}}
%}!}{
\newfun{bsmdoc|\tag{strong|bsmdoc}}
}
Once it is defined, it can be used as
{!div|bs-example||
\bsmdoc
!}
{!div|bs-example-src||highlight|bsmdoc||{%
\bsmdoc
%}!}
where \tag{code|\\bsmdoc} will be replaced with the result of \tag{code|{%\tag{strong|bsmdoc}%}}, i.e.,
{!highlight|html||{%
<strong>bsmdoc</strong>
%}!}

= Input Redirection
When the doc becomes large, you can split your doc into several docs and includes them in the top doc with the "\tag{code|\#include}" directive. For example, suppose you are writing a book, and have created \tag{b|chappter1.bsmdoc}, \tag{b|chapter2.bsmdoc}, .... Then, you can include all the chapters in your \tag{b|book.bsmdoc}

{!highlight|bsmdoc||{%
#include chapter1.bsmdoc
#include chapter2.bsmdoc
%}!}

bsmdoc will replace the line \tag{b|\#include chapter1.bsmdoc} with the content of the file \tag{b|chappter1.bsmdoc}.

The \tag{code|\#include} is implemented with function \tag{b|bsmdoc_include}
{!highlight|python||codesnippet||
bsmdoc_include_origin.func_closure
!}
Here \tag{code|data} will be anything following \tag{code|\#include}. In the previous example, it will be "\tag{b|chapter1.bsmdoc}" or "\tag{b|chapter2.bsmdoc}". If the file is opened successfully, by default \tag{b|bsmdoc_include} will return the filename and its content.

It is easy to extend the \tag{b|bsmdoc_include} function for more advanced applications, for example
{!highlight|bsmdoc||{%
{!exec|firstRunOnly||{%
bsmdoc_include_raw = BFunction().include
@BFunction('include')
def bsmdoc_include(data):
    # assume 'data' has multiple sections separated by '|', in the format of
    # PATTERN | MAX LINE | FILENAME
    d = data.strip().split('|')
    if len(d) == 1:
        # one section, return the default
        return bsmdoc_include_raw(data)
    elif len(d) == 3:
        import re
        # assume the last parameter is the filename
        c = bsmdoc_include_raw(d[-1])
        if not c:
            # invalid filename
            return c
        lines = c[1].split('\n')
        pattern = []
        for i, l in enumerate(lines):
            # search the PATTERN
            if re.match(d[0], l):
               pattern.append(i)
            if len(pattern) == 2:
                # return the content between the first and second instances of PATTERN
                if pattern[1] - pattern[0] > int(d[1]):
                    # too many lines, cut it
                    pattern[1] = pattern[0] + int(d[1])
                return (c[0], '\n'.join(lines[pattern[0]+1:pattern[1]]))
        return c
    return None
%}!}
%}!}

Then the following code will include the content between the first two headings from file \tag{b|myfile.bsmdoc}. And the maximum number of lines is limited to 16.
{!highlight|bsmdoc||{%
#include ^(\\s)*=+|16|./myfile.bsmdoc
%}!}

= HTML Template \label{sec-template}
By default, bsmdoc uses the following template to generate the html file, which defines 4 sections (i.e., \tag{b|html}, \tag{b|header}, \tag{b|body} and \tag{b|footer})

{!highlight|ini||codesnippet||
bsmdoc_conf
!}

Using a separate configuration file seems not to be compatible with our goal to include everything in a single file, although sometimes it may be convenient (for example, to use the same configuration file for multiple docs). bsmdoc also provides a way to include the customized template in your doc, for example
{!highlight|ini||{%
{!config||{%
[html]
begin = <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
end= </html>
...
%}!}
%}!}

In this case, "\tag{b|config}" function block is called without any argument. And its content should have a INI file structure.

bsmdoc uses [https://docs.python.org/2/library/configparser.html|ConfigParser] to parse the configurations. Thus, \tag{b|\%()s} will be resolved to the corresponding configuration values. The configuration name is case insensitive. For example,

- {\tag{b|\%(TITLE)s} will be replaced with "\tag{b|my html title}", if you config the title with
{!highlight|bsmdoc||{%
\config{title|my html title}
%}!}}
- \tag{b|\%(UPDATED)s} will be replaced with the time when the html file is generated.
- \tag{b|\%(SOURCE)s} will be replaced with the bsmdoc filename.

It is easy to create a configuration by
- {define the macro content, e.g.,
{!highlight|bsmdoc||{%
\config{MYMACRO|...}
%}!}}
- {use the configuration in the template
{!highlight|bsmdoc||{%
...%(MYMACRO}s...
%}!}}


bsmdoc defines "\tag{code|css}" configuration to insert additional \tag{code|css} in the html file without change the html template

{!highlight|bsmdoc||{%
\config{css|my.css}
%}!}

To insert multiple css files, separate them with white-space
{!highlight|bsmdoc||{%
\config{css|my.css my2.css}
%}!}
or
{!highlight|bsmdoc||{%
\config{css|my.css}
\config{css|add|my2.css}
%}!}
where \tag{code|add} option tells bsmdoc to append the configuration to the current one.

Similarly, bsmdoc also defines the "\tag{code|js}" configuration to include javascripts in the html file
{!highlight|bsmdoc||{%
\config{js|myjs.js myjs2.js}
%}!}

There are two ways to define doc title. The first one is to use the \tag{code|toptitle} configuration. For example, the following line will define the top title
{!div|bs-example||highlight|html||{%
<div class="toptitle">
    bsmdoc -- another technical html doc generator
    <div class="subtitle">
        <a href='mailto:tq@feiyilin.com'>tq@feiyilin.com</a>
    </div>
</div>
%}!}
{!div|bs-example-src||highlight|bsmdoc||{%
\config{doctitle|bsmdoc -- another technical html doc generator}
\config{subtitle|[mailto:tq@feiyilin.com|tq@feiyilin.com]}
%}!}

It is easy to see that it is equivalent to the following code

{!highlight|bsmdoc||{%
{!div|toptitle||
bsmdoc -- another technical html doc generator
{!div|subtitle||
[mailto:tq@feiyilin.com|tq@feiyilin.com]
!}
!}
%}!}
